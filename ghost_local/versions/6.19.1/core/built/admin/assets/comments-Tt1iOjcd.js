import{r as m,j as e,y as C,$ as ve,cV as ee,cW as Ne,bH as E,cz as we,cX as Ce,X as ke,cY as ye,B as b,bb as _e,ak as Se,ad as se,ae as H,b_ as D,b$ as I,c0 as F,c1 as $,cy as P,cK as Pe,D as O,t as B,v as U,w as V,a9 as Le,aa as q,cZ as Te,c_ as Me,bE as Re,ap as ze,bK as De,bF as Ie,bG as T,x as Fe,c$ as $e,f as L,bn as te,bD as M,aj as Ee,z as A,bv as He,bx as Oe,by as Be,bz as Ue,aR as Ve,d0 as ae,ck as qe}from"./index-Bgo4hw-T.js";import{F as Ae,c as Qe}from"./filters-6zg35bLL.js";import{u as We,g as Ke}from"./posts-C94RiQ4S.js";import{M as Ge,b as Q,a as Ye,F as Xe,d as Ze,C as Je,e as re,D as W,E as ne,f as ie}from"./message-square-text-DzuHB7uU.js";import{H as Y,g as es,u as ss}from"./use-infinite-virtual-scroll-CdNJ5RT5.js";import{M as ts}from"./main-layout-DBVy-lM5.js";import{C as le,a as as}from"./index-_dLVP2u2.js";import{L as rs}from"./label-BQ5mfFHN.js";import{R as ns}from"./reply-CUazFbTY.js";import{E as oe}from"./empty-indicator-CzTRebSi.js";const ce=m.forwardRef(({className:s,...t},a)=>e.jsx(le,{ref:a,className:C("grid place-content-center peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...t,children:e.jsx(as,{className:C("grid place-content-center text-current"),children:e.jsx(ve,{className:"size-4"})})}));ce.displayName=le.displayName;const is=({children:s,className:t,...a})=>e.jsx("section",{className:C("flex gap-6 flex-col p-4 lg:p-8 size-full grow",t),...a,children:s});function X({knownItems:s,useSearch:t,useGetById:a,filters:r,filterFieldName:n,searchFieldName:l,toOption:o}){const[i,c]=m.useState(""),{data:d,isLoading:x}=t(i),h=m.useMemo(()=>{const k=r.find(j=>j.field===n);return k?.values[0]?String(k.values[0]):""},[r,n]),v=m.useMemo(()=>!h||s.some(j=>j.id===h)?!1:!(d?.[l]??[]).some(j=>j.id===h),[h,s,d,l]),{data:p,isLoading:f}=a(h||"",{enabled:v,defaultErrorHandler:!1}),y=x||f,N=m.useCallback(k=>o(k),[o]);return{options:m.useMemo(()=>{const k=d?.[l]??[],j={};for(const g of s)j[g.id]=N(g);for(const g of k)j[g.id]=N(g);const w=p?.[l]?.[0];return w?.id&&(j[w.id]=N(w)),h&&!(h in j)&&(j[h]={value:h,label:`ID: ${h}`}),Object.values(j)},[s,d,l,p,h,N]),isLoading:y,searchValue:i,onSearchChange:c}}function ls(s){const[t]=ee(s,200);return Ne({searchParams:{...t&&{search:t},limit:"100",order:"created_at DESC"}})}function os(s){const[t]=ee(s,200),a=t?`title:~'${t.replace(/'/g,"\\'")}'`:"";return We({searchParams:{...a&&{filter:a},limit:"100",fields:"id,title",order:"published_at DESC"}})}const cs=({knownPosts:s,knownMembers:t,filters:a,onFiltersChange:r})=>{const n=X({knownItems:s,useSearch:os,useGetById:Ke,searchFieldName:"posts",filters:a,filterFieldName:"post",toOption:d=>({value:d.id,label:d.title||"(Untitled)"})}),l=X({knownItems:t,useSearch:ls,useGetById:ye,searchFieldName:"members",filters:a,filterFieldName:"author",toOption:d=>({value:d.id,label:d.name||"Unknown name",detail:d.email??"(Unknown email)"})}),o=m.useMemo(()=>[{key:"author",label:"Author",type:"select",icon:e.jsx(E,{className:"size-4"}),options:l.options,isLoading:l.options.length===0&&l.isLoading,onSearchChange:l.onSearchChange,searchValue:l.searchValue,searchable:!0,className:"w-80",popoverContentClassName:"w-80",operators:[{value:"is",label:"is"},{value:"is_not",label:"is not"}]},{key:"post",label:"Post",type:"select",icon:e.jsx(we,{className:"size-4"}),options:n.options,isLoading:n.options.length===0&&n.isLoading,onSearchChange:n.onSearchChange,searchValue:n.searchValue,searchable:!0,className:"w-full max-w-80",popoverContentClassName:"w-full max-w-[calc(100vw-32px)] max-w-80",operators:[{value:"is",label:"is"},{value:"is_not",label:"is not"}]},{key:"body",label:"Text",type:"text",icon:e.jsx(Ge,{className:"size-4"}),placeholder:"Search comment text...",operators:[{value:"contains",label:"contains"},{value:"not_contains",label:"does not contain"}],defaultOperator:"contains",className:"w-full max-w-48",popoverContentClassName:"w-full max-w-48"},{key:"status",label:"Status",type:"select",icon:e.jsx(Ce,{className:"size-4"}),options:[{value:"published",label:"Published"},{value:"hidden",label:"Hidden"}],operators:[{value:"is",label:"is"}],searchable:!1,hideOperatorSelect:!0},{key:"reported",label:"Reported",type:"select",icon:e.jsx(Q,{className:"size-4"}),options:[{value:"true",label:"Yes"},{value:"false",label:"No"}],operators:[{value:"is",label:"is"}],searchable:!1,hideOperatorSelect:!0},{key:"created_at",label:"Date",type:"date",className:"w-full max-w-32",icon:e.jsx(Ye,{className:"size-4"}),operators:[{value:"is",label:"is"},{value:"before",label:"before"},{value:"after",label:"after"}]}],[n,l]),i=a.length>0,c=C("flex flex-row",!i&&"[grid-area:actions] pt-5 justify-start sm:justify-end sm:pt-0",i&&"col-start-1 col-end-4 row-start-3 pt-5");return e.jsx("div",{className:c,children:e.jsx(Ae,{addButtonIcon:i?e.jsx(Xe,{}):e.jsx(Ze,{}),addButtonText:i?"Add filter":"Filter",allowMultiple:!1,className:`[&>button]:order-last ${i?"[&>button]:border-none":"w-auto"}`,clearButtonClassName:"font-normal text-muted-foreground",clearButtonIcon:e.jsx(ke,{}),clearButtonText:"Clear",fields:o,filters:a,keyboardShortcut:"f",popoverAlign:i?"start":"end",showClearButton:i,showSearchInput:!1,onChange:r})})},ds=({children:s})=>e.jsxs(Y,{className:"relative !pb-6 md:sticky",variant:"inline-nav",children:[e.jsx(Y.Title,{children:"Comments"}),s]}),ms=({children:s})=>e.jsx(ts,{children:e.jsx("div",{className:"grid w-full grow",children:e.jsx("div",{className:"flex h-full flex-col","data-testid":"comments-page",children:s})})});function us({onClick:s,expanded:t}){return e.jsxs(b,{className:"shrink-0 gap-0.5 self-start p-0 text-base hover:bg-transparent",variant:"ghost",onClick:s,children:[t?"Show less":"Show more",t?e.jsx(Je,{}):e.jsx(_e,{})]})}function de({item:s}){const t=m.useRef(null),[a,r]=m.useState(!1),[n,l]=m.useState(!1);return m.useEffect(()=>{if(n)return;const o=()=>{t.current&&r(t.current.scrollHeight>t.current.clientHeight)};return o(),window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[s.html,n]),e.jsx("div",{className:"mt-1 flex flex-col gap-2",children:e.jsxs("div",{className:`flex max-w-full flex-col items-start ${s.status==="hidden"&&"opacity-50"}`,children:[e.jsx("div",{dangerouslySetInnerHTML:{__html:s.html||""},ref:t,className:C("prose flex-1 text-base max-w-[80ch] balance leading-[1.5em] [&_*]:leading-[1.5em] [&_*]:text-base [&_*]:font-normal [&_blockquote]:border-l-[3px] [&_blockquote]:border-foreground [&_blockquote]:p-0 [&_blockquote]:pl-3 [&_blockquote_p]:mt-0 [&_a]:underline",n?"-mb-1 [&_p]:mb-[0.85em]":"line-clamp-2 [&_p]:m-0 [&_blockquote+p]:mt-1 mb-1")}),a&&e.jsx(us,{expanded:n,onClick:()=>l(!n)})]})})}const R="CommentsResponseType",hs=Se({dataType:R,path:"/comments/",defaultNextPageParams:(s,t)=>{var a,r;return(a=s.meta)!=null&&a.pagination.next?{...t,page:(((r=s.meta)==null?void 0:r.pagination.next)||1).toString()}:void 0},returnData:s=>{const{pages:t}=s,a=t.flatMap(n=>n.comments),r=t[t.length-1].meta;return{comments:a,meta:r,isEnd:r?r.pagination.pages===r.pagination.page:!0}}}),me=s=>hs({...s,searchParams:{limit:"100",order:"created_at desc",include:"member,post,parent",...s?.searchParams}}),ue=se({method:"PUT",path:({id:s})=>`/comments/${s}/`,body:({id:s})=>({comments:[{id:s,status:"hidden"}]}),invalidateQueries:{dataType:R}}),he=se({method:"PUT",path:({id:s})=>`/comments/${s}/`,body:({id:s})=>({comments:[{id:s,status:"published"}]}),invalidateQueries:{dataType:R}}),xs=H({dataType:R,path:s=>`/comments/${s}/`,defaultSearchParams:{include:"member,post,count.replies,count.direct_replies,count.likes,count.reports,parent,in_reply_to"}}),ps=H({dataType:"CommentReportsResponseType",path:s=>`/comments/${s}/reports/`}),fs=(s,t)=>ps(s,{...t}),js=H({dataType:"CommentLikesResponseType",path:s=>`/comments/${s}/likes/`,defaultSearchParams:{include:"member",limit:"100",order:"created_at desc"}}),gs=(s,t)=>js(s,{...t}),bs=(s,t)=>me({...t,searchParams:{filter:`(parent_id:${s}+in_reply_to_id:null),in_reply_to_id:${s}`,order:"created_at asc",include:"member,post,count.direct_replies,count.likes,count.reports,parent,in_reply_to",limit:"100"}});function S({avatarImage:s,memberId:t,isHidden:a,className:r}){return e.jsxs("div",{className:C("relative flex size-6 min-w-6 items-center justify-center overflow-hidden rounded-full bg-accent md:size-8 md:min-w-8",a&&"opacity-50",r),children:[t&&s&&e.jsx("div",{className:"absolute inset-0",children:e.jsx("img",{alt:"Member avatar",src:s})}),e.jsx("div",{children:e.jsx(E,{className:"!size-3 text-muted-foreground md:!size-4",size:12})})]})}function vs(s){const t=new Date(s);return new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"}).format(t).replace(/(\d+),(\s+\d{4})/,"$1$2")}function xe({memberName:s,memberId:t,createdAt:a,isHidden:r,canComment:n,onAuthorClick:l,postTitle:o,onPostClick:i,className:c}){return e.jsxs("div",{className:C("flex items-baseline gap-4",c),children:[e.jsxs("div",{className:C("mb-1 flex min-w-0 items-center gap-x-1 text-sm",r&&"opacity-50"),children:[e.jsx("div",{className:"whitespace-nowrap",children:t&&l?e.jsx(b,{className:"flex h-auto items-center gap-1.5 truncate p-0 font-semibold text-primary hover:opacity-70",variant:"link",onClick:l,children:s||"Unknown"}):e.jsx("span",{className:"block truncate font-semibold",children:s||"Unknown"})}),n===!1&&e.jsx(D,{children:e.jsxs(I,{children:[e.jsx(F,{asChild:!0,children:e.jsx("span",{"data-testid":"commenting-disabled-indicator",children:e.jsx(re,{className:"size-3.5 text-muted-foreground"})})}),e.jsx($,{children:"Comments disabled"})]})}),e.jsx(W,{className:"shrink-0 text-muted-foreground/50",size:16}),e.jsx("div",{className:"shrink-0 whitespace-nowrap",children:a&&e.jsx(D,{children:e.jsxs(I,{children:[e.jsx(F,{asChild:!0,children:e.jsx("span",{className:"cursor-default text-sm text-muted-foreground",children:P(a)})}),e.jsx($,{children:vs(a)})]})})}),o&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"shrink-0 text-muted-foreground",children:"on"}),e.jsx("div",{className:"min-w-0 truncate",children:i?e.jsx(b,{className:"block h-auto w-full cursor-pointer truncate p-0 text-left font-medium text-gray-800 hover:opacity-70 dark:text-gray-400",variant:"link",onClick:i,children:o}):e.jsx("span",{className:"font-medium text-gray-800 dark:text-gray-400",children:o})})]})]}),r&&e.jsx(Pe,{variant:"secondary",children:"Hidden"})]})}function Ns({open:s,memberName:t,onOpenChange:a,onConfirm:r}){const[n,l]=m.useState(!1),o=c=>{c||l(!1),a(c)},i=()=>{r(n),l(!1)};return e.jsx(O,{open:s,onOpenChange:o,children:e.jsxs(B,{className:"gap-5",children:[e.jsxs(U,{children:[e.jsx(V,{children:"Disable comments"}),e.jsxs(Le,{children:[t||"This member"," won't be able to comment in the future. You can re-enable commenting anytime."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{checked:n,id:"hide-comments",onCheckedChange:c=>l(c===!0)}),e.jsx(rs,{htmlFor:"hide-comments",children:"Hide all previous comments"})]}),e.jsxs(q,{children:[e.jsx(b,{variant:"outline",onClick:()=>o(!1),children:"Cancel"}),e.jsx(b,{onClick:i,children:"Disable comments"})]})]})})}function pe({comment:s}){const{mutate:t}=Te(),{mutate:a}=Me(),[r,n]=m.useState(!1),{id:l,post:o,member:i}=s,c=o?.url,d=i?.id,x=i?.can_comment,h=p=>{d&&(t({id:d,reason:`Disabled from comment ${l}`,hideComments:p}),n(!1))},v=()=>{d&&a({id:d})};return e.jsxs(e.Fragment,{children:[e.jsxs(Re,{children:[e.jsx(ze,{asChild:!0,children:e.jsx(b,{className:"relative z-10 text-gray-800 hover:bg-secondary [&_svg]:size-4",size:"sm",variant:"ghost",children:e.jsx(De,{})})}),e.jsxs(Ie,{align:"start",children:[c&&e.jsx(T,{asChild:!0,children:e.jsxs("a",{href:`${c}#ghost-comments-${l}`,rel:"noopener noreferrer",target:"_blank",children:[e.jsx(Fe,{className:"size-4"}),"View on post"]})}),d&&e.jsx(T,{asChild:!0,children:e.jsxs("a",{href:`#/members/${d}`,children:[e.jsx(E,{className:"size-4"}),"View member"]})}),d&&(x!==!1?e.jsxs(T,{onClick:()=>n(!0),children:[e.jsx(re,{className:"size-4"}),"Disable commenting"]}):e.jsxs(T,{onClick:v,children:[e.jsx($e,{className:"size-4"}),"Enable commenting"]}))]})]}),e.jsx(Ns,{memberName:i?.name,open:r,onConfirm:h,onOpenChange:n})]})}function ws({comment:s,open:t,onOpenChange:a}){const{data:r,isLoading:n}=gs(s.id,{enabled:t}),l=r?.comment_likes??[],o=s.count?.likes??0,i=o-l.length;return e.jsx(O,{open:t,onOpenChange:a,children:e.jsxs(B,{"aria-describedby":void 0,children:[e.jsx(U,{children:e.jsxs(V,{children:[o," ",o===1?"like":"likes"]})}),e.jsx("div",{className:"overflow-hidden rounded-md border p-3",children:e.jsxs("div",{className:"flex min-w-0 items-start gap-3",children:[e.jsx(S,{avatarImage:s.member?.avatar_image,className:"shrink-0",memberId:s.member?.id}),e.jsxs("div",{className:"flex min-w-0 flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-1 text-sm",children:[e.jsx("span",{className:"shrink-0 font-semibold",children:s.member?.name||"Unknown"}),e.jsx(W,{className:"shrink-0 text-muted-foreground/50",size:16}),e.jsx("span",{className:"shrink-0 text-muted-foreground",children:s.created_at&&P(s.created_at)}),e.jsx("span",{className:"shrink-0 text-muted-foreground",children:"on"}),e.jsx("span",{className:"min-w-0 truncate font-medium text-gray-800 dark:text-gray-400",children:s.post?.title||"Unknown post"})]}),e.jsx("div",{dangerouslySetInnerHTML:{__html:s.html||""},className:"prose mt-2 line-clamp-2 text-sm [&_*]:text-sm [&_*]:leading-[1.5em] [&_p]:m-0"})]})]})}),e.jsx("div",{className:"-mx-1 max-h-64 overflow-y-auto px-1",children:n?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(L,{size:"md"})}):e.jsxs("div",{className:"flex flex-col gap-3 pb-1",children:[l.map(c=>e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative shrink-0",children:[e.jsx(S,{avatarImage:c.member?.avatar_image,memberId:c.member?.id}),e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 flex size-4 items-center justify-center rounded-full bg-pink-500 text-white",children:e.jsx(te,{className:"size-2.5",fill:"currentColor"})})]}),e.jsx("span",{className:"font-medium",children:c.member?.name||"Deleted member"})]}),e.jsx("span",{className:"shrink-0 text-sm text-muted-foreground",children:P(c.created_at)})]},c.id)),i>0&&e.jsxs("div",{className:"pt-1 text-center text-sm text-muted-foreground",children:["and ",i," more"]})]})}),e.jsx(q,{children:e.jsx(b,{onClick:()=>a(!1),children:"OK"})})]})})}function Cs({comment:s,open:t,onOpenChange:a}){const{data:r,isLoading:n}=fs(s.id,{enabled:t}),l=r?.comment_reports??[],o=s.count?.reports??l.length;return e.jsx(O,{open:t,onOpenChange:a,children:e.jsxs(B,{"aria-describedby":void 0,children:[e.jsx(U,{children:e.jsxs(V,{children:[o," ",o===1?"report":"reports"]})}),e.jsx("div",{className:"overflow-hidden rounded-md border p-3",children:e.jsxs("div",{className:"flex min-w-0 items-start gap-3",children:[e.jsx(S,{avatarImage:s.member?.avatar_image,className:"shrink-0",memberId:s.member?.id}),e.jsxs("div",{className:"flex min-w-0 flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-1 text-sm",children:[e.jsx("span",{className:"shrink-0 font-semibold",children:s.member?.name||"Unknown"}),e.jsx(W,{className:"shrink-0 text-muted-foreground/50",size:16}),e.jsx("span",{className:"shrink-0 text-muted-foreground",children:s.created_at&&P(s.created_at)}),e.jsx("span",{className:"shrink-0 text-muted-foreground",children:"on"}),e.jsx("span",{className:"min-w-0 truncate font-medium text-gray-800 dark:text-gray-400",children:s.post?.title||"Unknown post"})]}),e.jsx("div",{dangerouslySetInnerHTML:{__html:s.html||""},className:"prose mt-2 line-clamp-2 text-sm [&_*]:text-sm [&_*]:leading-[1.5em] [&_p]:m-0"})]})]})}),e.jsx("div",{className:"-mx-1 max-h-64 overflow-y-auto px-1",children:n?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(L,{size:"md"})}):e.jsx("div",{className:"flex flex-col gap-3 pb-1",children:l.map(i=>e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative shrink-0",children:[e.jsx(S,{avatarImage:i.member?.avatar_image,memberId:i.member?.id}),e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 flex size-4 items-center justify-center rounded-full bg-red text-white",children:e.jsx(Q,{className:"size-2.5",fill:"currentColor"})})]}),e.jsx("span",{className:"font-medium",children:i.member?.name||"Deleted member"})]}),e.jsx("span",{className:"shrink-0 text-sm text-muted-foreground",children:P(i.created_at)})]},i.id))})}),e.jsx(q,{children:e.jsx(b,{onClick:()=>a(!1),children:"OK"})})]})})}function z({icon:s,count:t,label:a,to:r,onClick:n,className:l,testId:o}){const i=C("flex items-center gap-1 text-xs text-gray-800",l),c=e.jsxs(e.Fragment,{children:[s,e.jsx("span",{children:Ee(t)})]}),d=r||n;return e.jsx(D,{children:e.jsxs(I,{children:[e.jsx(F,{asChild:!0,children:r?e.jsx(A,{className:C(i,"cursor-pointer hover:opacity-70"),"data-testid":o,to:r,onClick:x=>{x.stopPropagation()},children:c}):n?e.jsx("button",{className:C(i,"cursor-pointer hover:opacity-70"),"data-testid":o,type:"button",onClick:x=>{x.stopPropagation(),n()},children:c}):e.jsx("div",{className:i,"data-testid":o,children:c})}),e.jsx($,{children:d?`View ${a.toLowerCase()}`:a})]})})}function K(s,t){if(!t)return;const a=new URLSearchParams(s);return a.set("thread",`is:${t}`),`?${a.toString()}`}function fe({comment:s,className:t}){const[a]=M(),[r,n]=m.useState(!1),[l,o]=m.useState(!1),i=K(a,s.id),c=s.count?.direct_replies??s.count?.replies??s.replies?.length??0,d=s.count?.likes??0,x=s.count?.reports??0,h=c>0,v=d>0,p=x>0;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:C("flex items-center gap-6",t),children:[e.jsx(z,{count:c,icon:e.jsx(ns,{size:16,strokeWidth:1.5}),label:"Replies",testId:"replies-metric",to:h?i:void 0}),e.jsx(z,{count:d,icon:e.jsx(te,{size:16,strokeWidth:1.5}),label:"Likes",onClick:v?()=>n(!0):void 0}),e.jsx(z,{className:p?"font-semibold text-red":void 0,count:x,icon:e.jsx(Q,{size:16,strokeWidth:1.5}),label:"Reports",onClick:p?()=>o(!0):void 0})]}),e.jsx(ws,{comment:s,open:r,onOpenChange:n}),e.jsx(Cs,{comment:s,open:l,onOpenChange:o})]})}function ks({hasReplies:s}){return s?e.jsx("div",{className:"mb-2 h-full w-px grow rounded bg-gradient-to-b from-muted-foreground/20 from-70% to-transparent","data-testid":"replies-line"}):null}function je({comment:s,isReply:t=!1,isSelectedComment:a=!1,selectedCommentId:r}){const[n]=M(),{mutate:l}=ue(),{mutate:o}=he(),i=(s.replies?.length??0)>0||(s.count?.direct_replies??s.count?.replies??0)>0,c=!i||t?"mb-7":"mb-0";return e.jsxs("div",{className:`flex w-full flex-row ${c}`,children:[e.jsxs("div",{className:"mr-2 flex shrink-0 flex-col items-center justify-start md:mr-3",children:[e.jsx(S,{avatarImage:s.member?.avatar_image,className:"mb-3 shrink-0 md:mb-4",isHidden:s.status==="hidden",memberId:s.member?.id}),e.jsx(ks,{hasReplies:i&&!t})]}),e.jsx("div",{className:"grow",children:e.jsxs("div",{className:"w-full","data-testid":`comment-thread-row-${s.id}`,children:[e.jsxs("div",{className:"flex min-w-0 flex-col",children:[e.jsx(xe,{canComment:s.member?.can_comment,createdAt:s.created_at,isHidden:s.status==="hidden",memberId:s.member?.id,memberName:s.member?.name}),s.in_reply_to_snippet&&a&&e.jsxs("div",{className:`mb-1 line-clamp-1 text-sm ${s.status==="hidden"&&"opacity-50"}`,children:[e.jsx("span",{className:"text-muted-foreground",children:"Replied to:"})," ",e.jsx(A,{className:"text-sm font-normal text-muted-foreground hover:text-foreground","data-testid":"replied-to-link",to:K(n,s.in_reply_to_id||s.parent_id)||"",onClick:d=>{d.stopPropagation()},children:s.in_reply_to_snippet})]}),e.jsx(de,{item:s}),e.jsxs("div",{className:"mt-4 flex flex-row flex-wrap items-center gap-3",children:[s.status==="published"&&e.jsxs(b,{className:"text-gray-800",size:"sm",variant:"outline",onClick:()=>l({id:s.id}),children:[e.jsx(ne,{}),e.jsx("span",{className:"max-md:hidden",children:"Hide"})]}),s.status==="hidden"&&e.jsxs(b,{className:"text-gray-800",size:"sm",variant:"outline",onClick:()=>o({id:s.id}),children:[e.jsx(ie,{}),e.jsx("span",{className:"max-md:hidden",children:"Show"})]}),e.jsx(fe,{comment:s}),e.jsx(pe,{comment:s})]})]}),i&&s.replies&&e.jsx("div",{className:"-ml-2 mb-4 mt-7 pl-2 md:-ml-3 md:mb-0 md:mt-8 md:pl-3",children:s.replies.map(d=>e.jsx(je,{comment:d,isReply:!0,selectedCommentId:r},d.id))})]})})]})}const ys=({selectedComment:s,replies:t,selectedCommentId:a,fetchNextPage:r,hasNextPage:n,isFetchingNextPage:l})=>{const o={...s,replies:t};return e.jsxs("div",{className:"flex flex-col","data-testid":"comment-thread-list",children:[e.jsx(je,{comment:o,isSelectedComment:!0,selectedCommentId:a}),n&&e.jsx("div",{className:"flex justify-center pb-4",children:e.jsx(b,{disabled:l,variant:"outline",onClick:()=>r(),children:l?e.jsxs(e.Fragment,{children:[e.jsx(L,{size:"sm"}),"Loading..."]}):"Load more replies"})})]})},_s=({commentId:s,open:t,onOpenChange:a})=>{const{data:r,isLoading:n,isError:l,fetchNextPage:o,hasNextPage:i,isFetchingNextPage:c}=bs(s??"",{enabled:t&&!!s}),{data:d,isLoading:x,isError:h}=xs(s??"",{enabled:t&&!!s}),v=n||x,p=h||l&&!d,f=d?.comments?.[0],y=r?.comments||[];return e.jsx(He,{open:t,onOpenChange:a,children:e.jsxs(Oe,{className:"overflow-y-auto px-6 pt-0 sm:max-w-[600px]",children:[e.jsx(Be,{className:"sticky top-0 z-40 -mx-6 bg-background/60 p-6 backdrop-blur",children:e.jsx(Ue,{className:"text-md",children:"Thread"})}),f?.post&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h3",{className:"line-clamp-1 text-xl font-semibold text-foreground",children:f.post.title}),f.post.excerpt&&e.jsx("p",{className:"mt-1 line-clamp-2 text-sm text-muted-foreground",children:f.post.excerpt})]}),f.post.feature_image&&e.jsx("img",{alt:f.post.title||"Post feature image",className:"hidden aspect-video h-18 shrink-0 rounded object-cover lg:block",src:f.post.feature_image})]}),e.jsx(Ve,{className:"-mx-6 my-6 w-auto"})]}),e.jsx("div",{children:v?e.jsx("div",{className:"flex h-full items-center justify-center py-8",children:e.jsx(L,{size:"lg"})}):p||!f?e.jsx("div",{className:"flex h-full items-center justify-center py-8",children:e.jsx(oe,{actions:e.jsx(b,{variant:"outline",onClick:()=>a(!1),children:"Back to comments"}),description:"This thread may have been deleted or doesn't exist.",title:"Thread not found",children:e.jsx(ae,{})})}):e.jsx(ys,{fetchNextPage:o,hasNextPage:i,isFetchingNextPage:c,replies:y,selectedComment:f,selectedCommentId:s??""})})]})})},Z=new Map;function Ss({parentRef:s,enabled:t=!0,isLoading:a=!1}){const r=qe(),[n,l]=m.useState(null),o=m.useRef(null);m.useEffect(()=>{if(!t||!s.current)return;const i=es(s.current);l(i)},[t,s]),m.useEffect(()=>{if(!t||!n)return;const i=r.pathname+r.search,c=()=>{const d=n.scrollTop;Z.set(i,d)};return n.addEventListener("scroll",c),()=>n.removeEventListener("scroll",c)},[t,r.pathname,r.search,n]),m.useEffect(()=>{const i=r.pathname+r.search,c=Z.get(i);if(!(!t||!n||a)){if(c!==void 0&&o.current!==i){let d=0;const x=3,h=()=>{if(d+=1,!n)return;const p=n.scrollTop,f=n.scrollHeight,y=n.clientHeight,N=f-y;if(c>N&&d<x){setTimeout(h,100);return}if(Math.abs(c-p)>5){const _=Math.min(c,N);n.scrollTop=_}},v=setTimeout(h,150);return()=>clearTimeout(v)}o.current=i}},[t,r.pathname,r.search,n,a])}const J=({height:s})=>e.jsx("div",{"aria-hidden":"true",className:"flex",children:e.jsx("div",{className:"flex",style:{height:s}})}),Ps=m.forwardRef(function(t,a){return e.jsx("div",{ref:a,...t,"aria-hidden":"true",className:"relative flex flex-col",children:e.jsx("div",{className:"relative z-10 h-24 animate-pulse",children:e.jsx("div",{className:"h-full rounded-md bg-muted","data-testid":"loading-placeholder"})})})});function Ls({items:s,totalItems:t,hasNextPage:a,isFetchingNextPage:r,fetchNextPage:n,onAddFilter:l,isLoading:o}){const i=m.useRef(null),[c,d]=M(),[x,h]=m.useState(!1),[v,p]=m.useState(null),{mutate:f}=ue(),{mutate:y}=he(),N=w=>{if(h(w),!w){const g=new URLSearchParams(c);g.delete("thread"),d(g,{replace:!0})}};m.useEffect(()=>{const w=c.get("thread");if(w){const g=w.match(/^is:(.+)$/);if(g&&g[1]){const u=g[1];p(u),h(!0)}else h(!1),p(null)}else h(!1),p(null)},[c]),Ss({parentRef:i,isLoading:o});const{visibleItems:_,spaceBefore:k,spaceAfter:j}=ss({items:s,totalItems:t,hasNextPage:a,isFetchingNextPage:r,fetchNextPage:n,parentRef:i});return e.jsxs("div",{ref:i,className:"overflow-hidden",children:[e.jsx("div",{className:"flex flex-col","data-testid":"comments-list",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx(J,{height:k}),_.map(({key:w,virtualItem:g,item:u,props:G})=>g.index>s.length-1?e.jsx(Ps,{...G},w):e.jsxs("div",{...G,className:"grid w-full grid-cols-1 items-start justify-between gap-4 border-b p-3 hover:bg-muted/50 md:p-5 lg:grid-cols-[minmax(0,1fr)_144px]","data-testid":"comment-list-row",onClick:()=>{x&&N(!1)},children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(S,{avatarImage:u.member?.avatar_image,isHidden:u.status==="hidden",memberId:u.member?.id}),e.jsxs("div",{className:"flex min-w-0 flex-col",children:[e.jsx(xe,{canComment:u.member?.can_comment,createdAt:u.created_at,isHidden:u.status==="hidden",memberId:u.member?.id,memberName:u.member?.name,postTitle:u.post?.title,onAuthorClick:u.member?.id?()=>l("author",u.member.id):void 0,onPostClick:u.post?.id?()=>l("post",u.post.id):void 0}),u.in_reply_to_snippet&&e.jsxs("div",{className:`mb-1 line-clamp-1 max-w-3xl text-sm ${u.status==="hidden"&&"opacity-50"}`,children:[e.jsx("span",{className:"text-muted-foreground",children:"Replied to:"})," ",e.jsx(A,{className:"text-sm font-normal text-muted-foreground hover:text-foreground","data-testid":"replied-to-link",to:K(c,u.in_reply_to_id||u.parent_id)||"",onClick:be=>{be.stopPropagation()},children:u.in_reply_to_snippet})]}),e.jsx(de,{item:u}),e.jsxs("div",{className:"mt-4 flex flex-row flex-nowrap items-center gap-3",children:[u.status==="published"&&e.jsxs(b,{className:"text-foreground",size:"sm",variant:"outline",onClick:()=>f({id:u.id}),children:[e.jsx(ne,{}),"Hide"]}),u.status==="hidden"&&e.jsxs(b,{className:"text-foreground",size:"sm",variant:"outline",onClick:()=>y({id:u.id}),children:[e.jsx(ie,{}),"Show"]}),e.jsx(fe,{className:"ml-2",comment:u}),e.jsx(pe,{comment:u})]})]})]}),e.jsx("div",{children:u.post?.feature_image?e.jsx("img",{alt:u.post.title||"Post feature image",className:`hidden aspect-video w-36 rounded object-cover lg:block ${u.status==="hidden"&&"opacity-50"}`,src:u.post.feature_image}):null})]},w)),e.jsx(J,{height:j})]})}),e.jsx(_s,{commentId:v,open:x,onOpenChange:N})]})}const ge=["id","status","created_at","body","post","author","reported"];function Ts(s){const t=[];for(const a of s)if(a.values[0])switch(a.field){case"id":t.push(`id:'${a.values[0]}'`);break;case"status":t.push(`status:${a.values[0]}`);break;case"created_at":if(a.operator==="before"&&a.values[0])t.push(`created_at:<'${a.values[0]}'`);else if(a.operator==="after"&&a.values[0])t.push(`created_at:>'${a.values[0]}'`);else if(a.operator==="is"&&a.values[0]){const l=String(a.values[0]),o=new Date(l+"T00:00:00").toISOString(),i=new Date(l+"T23:59:59.999").toISOString();t.push(`created_at:>='${o}'+created_at:<='${i}'`)}break;case"body":const n=a.values[0].replace(/'/g,"\\'");a.operator==="contains"?t.push(`html:~'${n}'`):a.operator==="not_contains"&&t.push(`html:-~'${n}'`);break;case"post":a.operator==="is_not"?t.push(`post_id:-${a.values[0]}`):t.push(`post_id:${a.values[0]}`);break;case"author":a.operator==="is_not"?t.push(`member_id:-${a.values[0]}`):t.push(`member_id:${a.values[0]}`);break;case"reported":a.values[0]==="true"?t.push("count.reports:>0"):a.values[0]==="false"&&t.push("count.reports:0");break}return t.length?t.join("+"):void 0}function Ms(s){if(!s)return null;const t=s.indexOf(":");return t<=0?null:{operator:s.substring(0,t),value:s.substring(t+1)}}function Rs(s){const t=[];for(const[a,r]of s.entries()){if(!ge.includes(a)||!r)continue;const n=Ms(r);n&&t.push({id:a,field:a,operator:n.operator,values:[n.value]})}return t}function zs(s){const t=new URLSearchParams;for(const a of s)if(ge.includes(a.field)&&a.values[0]!==void 0){const r=`${a.operator}:${String(a.values[0])}`;t.set(a.field,r)}return t}function Ds(){const[s,t]=M(),a=m.useMemo(()=>Rs(s),[s]),r=m.useCallback((i,c={})=>{const d=typeof i=="function"?i(a):i,x=zs(d),h=c.replace??!0;t(x,{replace:h})},[a,t]),n=m.useCallback(({replace:i=!0}={})=>{t(new URLSearchParams,{replace:i})},[t]),l=m.useMemo(()=>Ts(a),[a]),o=m.useMemo(()=>a.length===1&&a[0].field==="id",[a]);return{filters:a,nql:l,setFilters:r,clearFilters:n,isSingleIdFilter:o}}function Is({comments:s}){return m.useMemo(()=>{const t=new Map,a=new Map;for(const r of s)r.post?.id&&r.post?.title&&t.set(r.post.id,{id:r.post.id,title:r.post.title}),r.member?.id&&a.set(r.member.id,{id:r.member.id,name:r.member.name,email:r.member.email});return{knownPosts:Array.from(t.values()),knownMembers:Array.from(a.values())}},[s])}const Ws=()=>{const{filters:s,nql:t,setFilters:a,clearFilters:r,isSingleIdFilter:n}=Ds(),l=m.useCallback((N,_,k="is")=>{a(j=>[...j.filter(g=>g.field!==N),Qe(N,k,[_])],{replace:!1})},[a]),{data:o,isError:i,isFetching:c,isFetchingNextPage:d,isRefetching:x,fetchNextPage:h,hasNextPage:v}=me({searchParams:t?{filter:t}:{},keepPreviousData:!0}),{knownPosts:p,knownMembers:f}=Is({comments:o?.comments??[]}),y=c&&!d&&!x;return e.jsxs(ms,{children:[e.jsx(ds,{children:!n&&e.jsx(cs,{filters:s,knownMembers:f,knownPosts:p,onFiltersChange:a})}),e.jsx(is,{children:y?e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsx(L,{size:"lg"})}):i?e.jsxs("div",{className:"mb-16 flex h-full flex-col items-center justify-center",children:[e.jsx("h2",{className:"mb-2 text-xl font-medium",children:"Error loading comments"}),e.jsx("p",{className:"mb-4 text-muted-foreground",children:"Please reload the page to try again"}),e.jsx(b,{onClick:()=>window.location.reload(),children:"Reload page"})]}):o?.comments.length?e.jsxs(e.Fragment,{children:[e.jsx(Ls,{fetchNextPage:h,hasNextPage:v,isFetchingNextPage:d,isLoading:c&&!d,items:o?.comments??[],totalItems:o?.meta?.pagination?.total??0,onAddFilter:l}),n&&e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(b,{variant:"outline",onClick:()=>r({replace:!1}),children:"Show all comments"})})]}):e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsx(oe,{title:"No comments yet",children:e.jsx(ae,{})})})})]})};export{Ws as default};
